# ğŸ‘‡ Name of the GitHub Actions workflow
name: Deploy to VPS

# ğŸ‘‡ Trigger this workflow only when pushing to the 'master' branch
on:
  push:
    branches:
      - master  # âœ… Change to 'development' if testing from dev branch

jobs:
  deploy:
    # ğŸ‘‡ This job runs on GitHub's Ubuntu virtual machine
    runs-on: ubuntu-latest

    steps:
      # ğŸ‘‡ Step 1: Checks out the latest code from your GitHub repository
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ‘‡ Step 2: Runs a remote SSH script using appleboy/ssh-action
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          # ğŸ‘‡ These are GitHub Secrets configured in your repository
          host: ${{ secrets.VPS_HOST }}          # Your VPS IP or domain
          username: ${{ secrets.VPS_USER }}      # SSH username (e.g. ubuntu)
          key: ${{ secrets.VPS_SSH_KEY }}        # Private SSH key (no passphrase)
          
          # ğŸ‘‡ These commands run on your VPS after SSH connection
          script: |
            echo "âœ… Connecting to server..."

            # ğŸ‘‡ Navigate to your appâ€™s folder on the server
            cd /var/www/community.wotgonline.com/wotg-social-api

            echo "ğŸ” Pulling latest code..."
            git reset --hard               # Discards any local changes
            git pull origin master         # Pulls the latest commit from GitHub

            echo "ğŸ³ Rebuilding Docker containers..."
            docker compose down            # Stops and removes existing containers
            docker compose up -d --build   # Rebuilds and runs containers in detached mode
            
            docker restart wotg-social-admin-api # Restart admin API container

            echo "ğŸš€ Deployed!"
